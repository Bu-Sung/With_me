
<html>

<head>
   
    <link rel="stylesheet" href="search.css">
    <title>메인</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=l7xx34fbc458caac49f6b3fd63b8e1dcadd5"></script>
    <script type="text/javascript">
        var map, markerArr = [], marker;
        var x, y;
        function initTmap() {

            // 1. 지도 띄우기
            map = new Tmapv2.Map("map", {
                center: new Tmapv2.LatLng(37.570028, 126.986072),
                width: "100%",
                height: "400px",
                zoom: 15,
                zoomControl: false,
                scrollwheel: true

            });
            map.addListener("click", function onClick(evt) {
                var mapLatLng = evt.latLng;

                //기존 마커 삭제
                initmark();
                var markerPosition = new Tmapv2.LatLng(
                    mapLatLng._lat, mapLatLng._lng);
                //마커 올리기
                marker = new Tmapv2.Marker(
                    {
                        position: markerPosition,
                        icon: "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_b_m_p.png",
                        iconSize: new Tmapv2.Size(24, 38),
                        map: map
                    });

                var name = reverseGeo(mapLatLng._lng, mapLatLng._lat);
                document.getElementById("test").value = name;
            });
            $("#input").click(function () {
                var search = $('#test').val();

                initmark();
                // 명칭으로 검색
                $.ajax({
                    method: "GET",
                    url: "https://apis.openapi.sk.com/tmap/pois?version=1&format=json&callback=result",
                    async: false,
                    data: {
                        "appKey": "l7xx34fbc458caac49f6b3fd63b8e1dcadd5",
                        "searchKeyword": search,
                        "resCoordType": "EPSG3857",
                        "reqCoordType": "WGS84GEO",
                        "count": 1
                    },
                    success: function (response) {
                        var resultpoisData = response.searchPoiInfo.pois.poi;

                        var positionBounds = new Tmapv2.LatLngBounds();	//맵에 결과물 확인 하기 위한 LatLngBounds객체 생성    
                        var noorLat = Number(resultpoisData[0].noorLat); // 좌표의 경도
                        var noorLon = Number(resultpoisData[0].noorLon); // 좌표의 위도
                        //var name = resultpoisData[0].name; //좌표의 실제 명칭

                        var pointCng = new Tmapv2.Point(noorLon, noorLat);
                        var projectionCng = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(pointCng);

                        var lat = projectionCng._lat;
                        var lon = projectionCng._lng;
                        var name = reverseGeo(lon, lat);
                        var markerPosition = new Tmapv2.LatLng(lat, lon);
                        //마커
                        marker = new Tmapv2.Marker({
                            position: markerPosition,
                            icon: "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_b_m_p.png",
                            iconSize: new Tmapv2.Size(24, 38),
                            title: name, //주소이름
                            map: map
                        });
                        document.getElementById("test").value = name;// 검색된 내용으로 상세 표시
                        markerArr.push(marker); //마커를 누르면 상세 주소
                        map.setCenter(markerPosition);
                        map.zoomIn();
                    },
                    error: function (request, status, error) {
                        console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                    }
                }); //설정하기 클릭시 마커
            });
        }

        function initmark() {
            if (markerArr.length > 0) {
                markerArr[0].setMap(null);
            }
            if (marker != null) {
                marker.setMap(null);
            }

        }
        // 신 주소 값을 리턴
        function reverseGeo(x, y) {
            var newRoadAddr;
            $.ajax({
                method: "GET",
                url: "https://apis.openapi.sk.com/tmap/geo/reversegeocoding?version=1&format=json&callback=result",
                async: false,
                data: {
                    "appKey": "l7xx34fbc458caac49f6b3fd63b8e1dcadd5",
                    "coordType": "WGS84GEO",
                    "addressType": "A10",
                    "lon": x,
                    "lat": y
                },
                success: function (response) {
                    // 3. json에서 주소 파싱
                    var arrResult = response.addressInfo;

                    //법정동 마지막 문자 
                    var lastLegal = arrResult.legalDong.charAt(arrResult.legalDong.length - 1);

                    // 새주소
                    newRoadAddr = arrResult.city_do + ' ' + arrResult.gu_gun + ' ';

                    if (arrResult.eup_myun == ''
                        && (lastLegal == "읍" || lastLegal == "면")) {//읍면
                        newRoadAddr += arrResult.legalDong;
                    } else {
                        newRoadAddr += arrResult.eup_myun;
                    }
                    newRoadAddr += ' ' + arrResult.roadName + ' '
                        + arrResult.buildingIndex;

                    // 새주소 법정동& 건물명 체크
                    if (arrResult.legalDong != ''
                        && (lastLegal != "읍" && lastLegal != "면")) {//법정동과 읍면이 같은 경우

                        if (arrResult.buildingName != '') {//빌딩명 존재하는 경우
                            newRoadAddr += (' (' + arrResult.legalDong
                                + ', ' + arrResult.buildingName + ') ');
                        } else {
                            newRoadAddr += (' (' + arrResult.legalDong + ')');
                        }
                    } else if (arrResult.buildingName != '') {//빌딩명만 존재하는 경우
                        newRoadAddr += (' (' + arrResult.buildingName + ') ');
                    }

                    //document.getElementById("test").value = newRoadAddr;

                    

                },
                error: function (request, status, error) {
                    console.log("code:" + request.status + "\n"
                        + "message:" + request.responseText + "\n"
                        + "error:" + error);
                }
            });
            return newRoadAddr;
        }
        function select() {
            document.getElementById("result").innerText= $('#test').val();
        }
    </script>
</head>

<body onload="initTmap();">
    <main class="search">
        <form class="search_form">
            <input type="text" width="80%" id="test">
            <input type="button" id="input" width="10%" value="검색"> 
        </form>
        <div id="map"></div>
        <button onclick="select()">위치 설정</button>  
        <p id="result">asd</p>
    </main>
</body>

</html>